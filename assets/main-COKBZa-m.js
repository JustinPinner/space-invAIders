(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const h of n.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const d={LEFT:"ArrowLeft",RIGHT:"ArrowRight",SHOOT:" "},o={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,PLAYER_WIDTH:32,PLAYER_HEIGHT:24,ALIEN_WIDTH:24,ALIEN_HEIGHT:18,BUILDING_WIDTH:48,BUILDING_HEIGHT:36,UFO_WIDTH:48,UFO_HEIGHT:24,ALIEN_ROWS:6,ALIEN_COLUMNS:8,BUILDING_COUNT:5,PLAYER_SPEED:6,BULLET_SPEED:-10,BOMB_SPEED:4,ALIEN_BASE_SPEED:1,UFO_SPEED:3,MAX_BULLETS:10,MAX_BOMBS:5,INITIAL_LIVES:3,SHOOT_COOLDOWN:250,UFO_MIN_SPAWN_TIME:3e4,UFO_MAX_SPAWN_TIME:9e4,ALIEN_POINTS:100,UFO_POINTS:200,BONUS_UFO_POINTS:400,LEVEL_BONUS:1e3,UI_HEIGHT:60,SCORE_OFFSET_X:20,LIVES_OFFSET_X:20,SCORE_OFFSET_Y:30,LIVES_OFFSET_Y:30,ALIEN_START_X:100,ALIEN_START_Y:100,ALIEN_SPACING_X:40,ALIEN_SPACING_Y:30,BUILDING_Y:500,BUILDING_START_X:150,BUILDING_SPACING_X:100,PLAYER_Y:550,PLAYER_START_X:384,UFO_Y:50,COLORS:{PLAYER:"#00ff00",ALIEN:"#ff0000",BUILDING:"#0088ff",UFO:"#ffff00",BULLET:"#00ff00",BOMB:"#ff8800",EXPLOSION:"#ff6600",UI_TEXT:"#ffffff",UI_BACKGROUND:"#111111"}};class v{constructor(t){this.score=0,this.lives=3,this.level=1,this.canvas=t,this.ctx=t.getContext("2d")}update(t){}render(){this.ctx.fillStyle=o.COLORS.UI_BACKGROUND,this.ctx.fillRect(0,0,this.canvas.width,o.UI_HEIGHT),this.renderLives(),this.renderTitle(),this.renderScore(),this.renderLevel()}renderLives(){this.ctx.fillStyle=o.COLORS.UI_TEXT,this.ctx.font='16px "Courier New", monospace',this.ctx.textAlign="left",this.ctx.fillText("LIVES:",o.LIVES_OFFSET_X,o.LIVES_OFFSET_Y);const t=o.LIVES_OFFSET_X+60,e=o.LIVES_OFFSET_Y-10;for(let i=0;i<this.lives;i++){const s=t+i*25;this.drawLifeIndicator(s,e)}for(let i=this.lives;i<o.INITIAL_LIVES;i++){const s=t+i*25;this.drawEmptyLifeIndicator(s,e)}}drawLifeIndicator(t,e){this.ctx.fillStyle=o.COLORS.PLAYER,this.ctx.beginPath(),this.ctx.moveTo(t+6,e),this.ctx.lineTo(t,e+10),this.ctx.lineTo(t+12,e+10),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillRect(t+4,e+8,4,2)}drawEmptyLifeIndicator(t,e){this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(t+6,e),this.ctx.lineTo(t,e+10),this.ctx.lineTo(t+12,e+10),this.ctx.closePath(),this.ctx.stroke(),this.ctx.strokeRect(t+4,e+8,4,2)}renderTitle(){this.ctx.fillStyle=o.COLORS.UI_TEXT,this.ctx.font='bold 24px "Courier New", monospace',this.ctx.textAlign="center",this.ctx.fillText("Space InvAIders",this.canvas.width/2,o.LIVES_OFFSET_Y)}renderScore(){this.ctx.fillStyle=o.COLORS.UI_TEXT,this.ctx.font='18px "Courier New", monospace',this.ctx.textAlign="right",this.ctx.fillText(`SCORE: ${this.score}`,this.canvas.width-o.SCORE_OFFSET_X,o.SCORE_OFFSET_Y)}renderLevel(){this.ctx.fillStyle=o.COLORS.UI_TEXT,this.ctx.font='16px "Courier New", monospace',this.ctx.textAlign="center",this.ctx.fillText(`LEVEL: ${this.level}`,this.canvas.width/2,o.LIVES_OFFSET_Y+30)}renderGameState(t){switch(this.ctx.fillStyle=o.COLORS.UI_TEXT,this.ctx.font='bold 36px "Courier New", monospace',this.ctx.textAlign="center",this.ctx.textBaseline="middle",t){case"menu":this.ctx.fillText("PRESS ENTER TO START",this.canvas.width/2,this.canvas.height/2),this.ctx.font='20px "Courier New", monospace',this.ctx.fillText("USE ARROW KEYS TO MOVE, SPACE TO SHOOT",this.canvas.width/2,this.canvas.height/2+50);break;case"paused":this.ctx.fillText("PAUSED",this.canvas.width/2,this.canvas.height/2),this.ctx.font='20px "Courier New", monospace',this.ctx.fillText("PRESS ESC TO RESUME",this.canvas.width/2,this.canvas.height/2+50);break;case"level-complete":this.ctx.fillText("LEVEL COMPLETE!",this.canvas.width/2,this.canvas.height/2),this.ctx.font='20px "Courier New", monospace',this.ctx.fillText("PREPARING NEXT LEVEL...",this.canvas.width/2,this.canvas.height/2+50);break;case"game-over":this.ctx.fillText("GAME OVER",this.canvas.width/2,this.canvas.height/2),this.ctx.font='20px "Courier New", monospace',this.ctx.fillText(`FINAL SCORE: ${this.score}`,this.canvas.width/2,this.canvas.height/2+50),this.ctx.fillText("PRESS ENTER TO RETURN TO MENU",this.canvas.width/2,this.canvas.height/2+80);break;case"victory":this.ctx.fillText("VICTORY!",this.canvas.width/2,this.canvas.height/2),this.ctx.font='20px "Courier New", monospace',this.ctx.fillText("ALL 20 LEVELS COMPLETED!",this.canvas.width/2,this.canvas.height/2+50),this.ctx.fillText(`FINAL SCORE: ${this.score}`,this.canvas.width/2,this.canvas.height/2+80),this.ctx.fillText("PRESS ENTER TO RETURN TO MENU",this.canvas.width/2,this.canvas.height/2+110);break}}setScore(t){this.score=t}setLives(t){this.lives=t}setLevel(t){this.level=t}getScore(){return this.score}getLives(){return this.lives}getLevel(){return this.level}}class w{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.layers=new Map;for(let e=0;e<=7;e++)this.layers.set(e,[])}beginFrame(){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}endFrame(){}addGameObject(t,e){const i=this.layers.get(e)||[];i.push(t),this.layers.set(e,i)}removeGameObject(t,e){const i=this.layers.get(e)||[],s=i.indexOf(t);s>-1&&(i.splice(s,1),this.layers.set(e,i))}render(){for(let t=0;t<=7;t++){const e=this.layers.get(t)||[];for(const i of e)i.active&&this.renderGameObject(i)}}renderGameObject(t){this.ctx.save(),this.ctx.fillStyle=t.color,this.ctx.strokeStyle=t.color,this.ctx.translate(t.x,t.y),t.render(this.ctx),this.ctx.restore()}clear(){for(const t of this.layers.keys())this.layers.set(t,[])}getCanvas(){return this.canvas}getContext(){return this.ctx}resize(t,e){this.canvas.width=t,this.canvas.height=e}}class b{constructor(){this.keys=new Map,this.keysPressed=new Map,this.setupEventListeners()}setupEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(t){const e=t.key;this.keys.get(e)||(this.keys.set(e,!0),this.keysPressed.set(e,Date.now()))}handleKeyUp(t){const e=t.key;this.keys.set(e,!1),this.keysPressed.delete(e)}isKeyPressed(t){return this.keys.get(t)||!1}isKeyJustPressed(t){const e=this.keysPressed.get(t);if(!e)return!1;const s=Date.now()-e<100;return s&&this.keysPressed.delete(t),s}getPressedKeys(){return Array.from(this.keys.keys()).filter(t=>this.keys.get(t))}reset(){this.keys.clear(),this.keysPressed.clear()}destroy(){document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this))}}class T{constructor(){this.masterVolume=.7,this.isMuted=!1,this.init()}async init(){try{console.log("Audio system initialized")}catch(t){console.warn("Audio initialization failed:",t)}}playSound(t){if(!this.isMuted)switch(console.log(`Playing sound: ${t}`),t){case"bomb-drop":this.playBombDropSound();break;case"player-death":this.playPlayerDeathSound();break;case"player-respawn":this.playPlayerRespawnSound();break;case"explosion":this.playExplosionSound();break;default:this.playDefaultSound(t);break}}stopSound(t){console.log(`Stopping sound: ${t}`)}playMusic(){console.log("Playing music")}stopMusic(){console.log("Stopping music")}setMasterVolume(t){this.masterVolume=Math.max(0,Math.min(1,t))}mute(){this.isMuted=!0}unmute(){this.isMuted=!1}isAudioEnabled(){return typeof AudioContext<"u"}getVolume(){return this.masterVolume}getIsMuted(){return this.isMuted}unlockAudio(){const t=new(window.AudioContext||window.webkitAudioContext);t&&t.state==="suspended"&&t.resume()}playBombDropSound(){this.createTone(150,.1,"sawtooth")}playPlayerDeathSound(){this.createTone(300,.5,"square"),setTimeout(()=>this.createTone(150,.3,"sawtooth"),100),setTimeout(()=>this.createTone(75,.2,"sine"),200)}playPlayerRespawnSound(){this.createTone(200,.1,"sine"),setTimeout(()=>this.createTone(400,.1,"sine"),100),setTimeout(()=>this.createTone(600,.2,"sine"),200)}playExplosionSound(){this.createNoise(.2)}playDefaultSound(t){this.createTone(440,.1,"square")}createTone(t,e,i="sine"){try{const s=new(window.AudioContext||window.webkitAudioContext),n=s.createOscillator(),h=s.createGain();n.connect(h),h.connect(s.destination),n.type=i,n.frequency.value=t,h.gain.setValueAtTime(this.masterVolume*.3,s.currentTime),h.gain.exponentialRampToValueAtTime(.01,s.currentTime+e),n.start(s.currentTime),n.stop(s.currentTime+e)}catch(s){console.warn("Failed to play tone:",s)}}createNoise(t){try{const e=new(window.AudioContext||window.webkitAudioContext),i=e.sampleRate*t,s=e.createBuffer(1,i,e.sampleRate),n=s.getChannelData(0);for(let l=0;l<i;l++)n[l]=Math.random()*2-1;const h=e.createBufferSource(),r=e.createGain();h.buffer=s,h.connect(r),r.connect(e.destination),r.gain.setValueAtTime(this.masterVolume*.2,e.currentTime),r.gain.exponentialRampToValueAtTime(.01,e.currentTime+t),h.start(e.currentTime),h.stop(e.currentTime+t)}catch(e){console.warn("Failed to play noise:",e)}}}var g=(a=>(a[a.BACKGROUND=0]="BACKGROUND",a[a.BUILDINGS=1]="BUILDINGS",a[a.ALIENS=2]="ALIENS",a[a.UFO=3]="UFO",a[a.PLAYER=4]="PLAYER",a[a.PROJECTILES=5]="PROJECTILES",a[a.PARTICLES=6]="PARTICLES",a[a.UI=7]="UI",a))(g||{});class c{constructor(t,e,i,s,n){this.id=`${n}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.x=t,this.y=e,this.width=i,this.height=s,this.velocity={x:0,y:0},this.active=!0,this.layer=g.BACKGROUND,this.color="#ffffff",this.type=n}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}setPosition(t,e){this.x=t,this.y=e}setVelocity(t,e){this.velocity.x=t,this.velocity.y=e}isColliding(t){const e=this.getBounds(),i=t.getBounds();return!(e.x+e.width<i.x||i.x+i.width<e.x||e.y+e.height<i.y||i.y+i.height<e.y)}setColor(t){this.color=t}destroy(){this.active=!1}isOffScreen(t,e){return this.x+this.width<0||this.x>t||this.y+this.height<0||this.y>e}}class E extends c{constructor(t,e,i,s){super(t,e,o.ALIEN_WIDTH,o.ALIEN_HEIGHT,"alien"),this.direction=1,this.row=i,this.column=s,this.setColor(o.COLORS.ALIEN)}update(t){}render(t){t.fillStyle=this.color,t.beginPath(),t.moveTo(this.x+this.width/2,this.y),t.lineTo(this.x+this.width,this.y+this.height/2),t.lineTo(this.x+this.width/2,this.y+this.height),t.lineTo(this.x,this.y+this.height/2),t.closePath(),t.fill(),t.fillStyle="#ffffff",t.fillRect(this.x+4,this.y+6,3,2),t.fillRect(this.x+this.width-7,this.y+6,3,2),t.strokeStyle="#ffffff",t.lineWidth=1,t.beginPath(),t.moveTo(this.x+this.width/2-2,this.y),t.lineTo(this.x+this.width/2-2,this.y-3),t.moveTo(this.x+this.width/2+2,this.y),t.lineTo(this.x+this.width/2+2,this.y-3),t.stroke()}setDirection(t){this.direction=t}getDirection(){return this.direction}getRow(){return this.row}getColumn(){return this.column}setPosition(t,e){this.x=t,this.y=e}moveLeft(t){this.x-=t}moveRight(t){this.x+=t}moveDown(t){this.y+=t}destroy(){this.active=!1}}class L{constructor(t){this.movementDirection=1,this.lastMoveTime=0,this.moveInterval=1e3,this.edgeReached=!1,this.audioSystem=t,this.aliens=[],this.initializeGrid()}setAudioSystem(t){this.audioSystem=t}initializeGrid(){this.aliens=[];for(let t=0;t<o.ALIEN_ROWS;t++){this.aliens[t]=[];for(let e=0;e<o.ALIEN_COLUMNS;e++){const i=o.ALIEN_START_X+e*o.ALIEN_SPACING_X,s=o.ALIEN_START_Y+t*o.ALIEN_SPACING_Y,n=new E(i,s,t,e);this.aliens[t][e]=n}}}update(t){const e=Date.now();e-this.lastMoveTime>=this.moveInterval&&(this.moveAliens(),this.lastMoveTime=e)}moveAliens(){this.edgeReached=this.checkEdgeCollision(),this.edgeReached?(this.audioSystem&&this.audioSystem.playSound("alien-edge"),this.moveAllAliensDown(),this.movementDirection*=-1):(this.audioSystem&&this.audioSystem.playSound("alien-move"),this.moveAllAliensHorizontally())}checkEdgeCollision(){for(let t=0;t<this.aliens.length;t++)for(let e=0;e<this.aliens[t].length;e++){const i=this.aliens[t][e];if(i&&i.active&&(this.movementDirection===1&&i.x+i.width>=o.CANVAS_WIDTH-20||this.movementDirection===-1&&i.x<=20))return!0}return!1}moveAllAliensHorizontally(){const t=o.ALIEN_BASE_SPEED*10;for(let e=0;e<this.aliens.length;e++)for(let i=0;i<this.aliens[e].length;i++){const s=this.aliens[e][i];s&&s.active&&(this.movementDirection===1?s.moveRight(t):s.moveLeft(t))}}moveAllAliensDown(){for(let t=0;t<this.aliens.length;t++)for(let e=0;e<this.aliens[t].length;e++){const i=this.aliens[t][e];i&&i.active&&i.moveDown(o.ALIEN_SPACING_Y)}}getAliens(){const t=[];for(const e of this.aliens)t.push(...e);return t}reset(){this.initializeGrid(),this.movementDirection=1,this.lastMoveTime=0,this.moveInterval=1e3,this.edgeReached=!1}getActiveAlienCount(){return this.getAliens().filter(t=>t.active).length}setMovementDirection(t){this.movementDirection=t}getMovementDirection(){return this.movementDirection}setMoveInterval(t){this.moveInterval=t}getMoveInterval(){return this.moveInterval}}class A extends c{constructor(t,e){super(t,e,o.BUILDING_WIDTH,o.BUILDING_HEIGHT,"building"),this.maxHealth=100,this.currentHealth=100,this.setColor(o.COLORS.BUILDING),this.damageSections=[];for(let i=0;i<4;i++){this.damageSections[i]=[];for(let s=0;s<5;s++)this.damageSections[i][s]=!1}}update(t){this.currentHealth<=0&&(this.active=!1)}render(t){if(!this.active)return;const e=this.currentHealth/this.maxHealth,i=this.width/5,s=this.height/4;for(let n=0;n<4;n++)for(let h=0;h<5;h++)if(!this.damageSections[n][h]){const r=1-e,l=Math.floor(0+r*255),y=Math.floor(136+r*-136),p=Math.floor(255+r*-255);t.fillStyle=`rgb(${l}, ${y}, ${p})`,t.fillRect(this.x+h*i,this.y+n*s,i-1,s-1)}t.strokeStyle=o.COLORS.BUILDING,t.lineWidth=2,t.strokeRect(this.x,this.y,this.width,this.height),this.renderHealthBar(t)}renderHealthBar(t){const e=this.width,i=4,s=this.y-10,n=this.currentHealth/this.maxHealth;t.fillStyle="#ff0000",t.fillRect(this.x,s,e,i),t.fillStyle="#00ff00",t.fillRect(this.x,s,e*n,i),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(this.x,s,e,i)}takeDamage(t){this.currentHealth=Math.max(0,this.currentHealth-t),this.applyVisualDamage(),this.currentHealth<=0&&this.destroy()}applyVisualDamage(){const t=1-this.currentHealth/this.maxHealth,e=Math.floor(t*20);let i=0;for(let s=0;s<4&&i<e;s++)for(let n=0;n<5&&i<e;n++)this.damageSections[s][n]||(this.damageSections[s][n]=!0,i++)}getHealth(){return this.currentHealth}getMaxHealth(){return this.maxHealth}getHealthPercentage(){return this.currentHealth/this.maxHealth}isDestroyed(){return this.currentHealth<=0}repair(){this.currentHealth=this.maxHealth;for(let t=0;t<4;t++)for(let e=0;e<5;e++)this.damageSections[t][e]=!1}destroy(){this.active=!1,this.currentHealth=0}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}class x{constructor(){this.buildings=[],this.initializeBuildings()}initializeBuildings(){this.buildings=[];for(let t=0;t<o.BUILDING_COUNT;t++){const e=o.BUILDING_START_X+t*o.BUILDING_SPACING_X,i=o.BUILDING_Y,s=new A(e,i);this.buildings.push(s)}}update(t){for(const e of this.buildings)e.active&&e.update(t);this.buildings=this.buildings.filter(e=>e.active)}render(t){for(const e of this.buildings)e.active&&e.render(t)}getBuildings(){return this.buildings.filter(t=>t.active)}getAllBuildings(){return this.buildings}checkCollisionWithProjectile(t,e,i,s){for(const n of this.buildings){if(!n.active)continue;const h=n.getBounds();if(this.isColliding(t,e,i,s,h.x,h.y,h.width,h.height))return n}return null}isColliding(t,e,i,s,n,h,r,l){return t<n+r&&t+i>n&&e<h+l&&e+s>h}reset(){this.initializeBuildings()}getBuildingCount(){return this.buildings.filter(t=>t.active).length}isAnyBuildingAtPosition(t,e){for(const i of this.buildings){if(!i.active)continue;const s=i.getBounds();if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height)return!0}return!1}}class O extends c{constructor(t,e,i=!1){super(t,e,o.UFO_WIDTH,o.UFO_HEIGHT,"ufo"),this.direction=1,this.pointValue=o.UFO_POINTS,this.isBonus=!1,this.setColor(o.COLORS.UFO),this.isBonus=i,this.pointValue=i?o.BONUS_UFO_POINTS:o.UFO_POINTS}update(t){this.x+=this.direction*o.UFO_SPEED*t/16.67,(this.direction===1&&this.x>o.CANVAS_WIDTH+50||this.direction===-1&&this.x<-50)&&(this.active=!1)}render(t){if(this.active){if(t.fillStyle=this.color,t.beginPath(),t.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/2,this.height/3,0,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(this.x+this.width/2,this.y+this.height/3,this.width/3,0,Math.PI,!1),t.fill(),this.isBonus){const e=Date.now(),i=Math.sin(e/200)>0;t.fillStyle=i?"#ff00ff":"#ff8800",t.beginPath(),t.arc(this.x+this.width/2-this.width/4,this.y+this.height/3,this.width/4,0,Math.PI*2,!1),t.fill(),t.beginPath(),t.arc(this.x+this.width/2+this.width/4,this.y+this.height/3,this.width/4,0,Math.PI*2,!1),t.fill()}this.isBonus&&(t.fillStyle="#ffff00",t.font="bold 12px Courier New",t.textAlign="center",t.fillText(this.pointValue.toString(),this.x+this.width/2,this.y-10)),this.isBonus&&(t.fillStyle="#ffff00",t.font="bold 12px Courier New",t.textAlign="center",t.fillText(this.pointValue.toString(),this.x+this.width/2,this.y-10))}}setDirection(t){this.direction=t}getDirection(){return this.direction}getPointValue(){return this.pointValue}isBonusUFO(){return this.isBonus}spawnFromLeft(){this.x=-48,this.y=o.UFO_Y,this.direction=1,this.active=!0}spawnFromRight(){this.x=o.CANVAS_WIDTH+o.UFO_WIDTH,this.y=o.UFO_Y,this.direction=-1,this.active=!0}destroy(){this.active=!1}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}class P{constructor(){this.ufo=null,this.nextSpawnTime=0,this.gameTime=0,this.calculateNextSpawnTime()}update(t,e=!0){this.gameTime+=t,e&&this.shouldSpawn()&&this.spawnUFO(),this.ufo&&this.ufo.active&&(this.ufo.update(t),this.ufo.active||(this.ufo=null))}render(t){this.ufo&&this.ufo.active&&this.ufo.render(t)}spawnUFO(t=!1){if(this.ufo&&this.ufo.active)return;this.ufo=new O(0,o.UFO_Y,t),(Math.random()<.5?1:-1)===1?this.ufo.spawnFromLeft():this.ufo.spawnFromRight(),this.calculateNextSpawnTime()}spawnBonusUFO(){this.spawnUFO(!0)}destroyUFO(){if(!this.ufo||!this.ufo.active)return console.log("destroyUFO called but UFO is null or inactive"),0;const t=this.ufo.getPointValue();return console.log("Destroying UFO, points:",t),this.ufo.destroy(),this.ufo=null,console.log("UFO destroyed, ufoSystem.isActive():",this.isActive()),t}getUFO(){return this.ufo}isActive(){return this.ufo!==null&&this.ufo.active}shouldSpawn(){return this.ufo&&this.ufo.active?!1:this.gameTime>=this.nextSpawnTime}calculateNextSpawnTime(){const t=o.UFO_MIN_SPAWN_TIME,e=o.UFO_MAX_SPAWN_TIME,i=t+Math.random()*(e-t);this.nextSpawnTime=this.gameTime+i}reset(){this.ufo=null,this.nextSpawnTime=0,this.gameTime=0,this.calculateNextSpawnTime()}getBounds(){return!this.ufo||!this.ufo.active?null:this.ufo.getBounds()}}class S{constructor(t,e=10,i=50){this.pool=[],this.active=[],this.maxSize=i;for(let s=0;s<e;s++)this.pool.push(t())}acquire(){let t=null;return this.pool.length>0?t=this.pool.pop():this.active.length<this.maxSize&&(t=this.createObject()),t&&this.active.push(t),t}release(t){const e=this.active.indexOf(t);e>-1&&(this.active.splice(e,1),this.resetObject(t),this.pool.push(t))}update(t){}getActive(){return this.active}getActiveCount(){return this.active.length}clear(){for(const t of this.active)this.resetObject(t),this.pool.push(t);this.active=[]}}class m extends c{constructor(t,e){super(t,e,4,8,"bomb"),this.setColor(o.COLORS.BOMB),this.layer=5}update(t){this.y+=o.BOMB_SPEED,this.y>o.CANVAS_HEIGHT+20&&this.destroy()}render(t){t.fillStyle=this.color,t.beginPath(),t.arc(this.x+this.width/2,this.y+this.height/2,this.width/2,0,Math.PI*2),t.fill(),t.beginPath(),t.moveTo(this.x+this.width/2-this.width/2,this.y+this.height/2),t.lineTo(this.x+this.width/2,this.y+this.height),t.lineTo(this.x+this.width/2+this.width/2,this.y+this.height/2),t.closePath(),t.fill(),t.shadowBlur=4,t.shadowColor=this.color,t.fill(),t.shadowBlur=0}destroy(){super.destroy()}}class C extends S{constructor(){super(()=>new m(0,0),5,o.MAX_BOMBS)}createBomb(t,e){const i=this.acquire();return i&&(i.setPosition(t,e),i.setColor(o.COLORS.BOMB),i.active=!0),i}update(t){for(let e=this.active.length-1;e>=0;e--){const i=this.active[e];i.update(t),(!i.active||i.y>o.CANVAS_HEIGHT+20)&&this.release(i)}}createObject(){return new m(0,0)}resetObject(t){t.active=!1,t.setPosition(0,0)}reset(){for(let t=this.active.length-1;t>=0;t--)this.release(this.active[t])}getActiveBombs(){return this.active}getActiveBombCount(){return this.active.length}}class I{constructor(t){this.bombDroppers=[],this.lastBombCheck=0,this.bombCheckInterval=2e3,this.bombPool=new C,this.maxSimultaneousBombs=4,this.audioSystem=t}setAudioSystem(t){this.audioSystem=t}getBombPool(){return this.bombPool}initializeBombDroppers(t){this.bombDroppers=[];const e=t.filter(n=>n.active),i=Math.min(5,e.length),s=[...e].sort(()=>Math.random()-.5);for(let n=0;n<i;n++){const h=s[n];this.bombDroppers.push({alien:h,lastBombTime:Date.now(),bombCooldown:this.getRandomBombCooldown()})}}update(t){this.bombPool.update(0);const e=Date.now();e-this.lastBombCheck>=this.bombCheckInterval&&(this.updateBombDroppers(t),this.lastBombCheck=e),this.tryDropBombs()}updateBombDroppers(t){const e=t.filter(s=>s.active),i=this.bombPool.getActiveBombCount();if(this.bombDroppers=this.bombDroppers.filter(s=>s.alien.active),this.bombDroppers.length<5&&i<this.maxSimultaneousBombs){const s=e.filter(n=>!this.bombDroppers.some(h=>h.alien.id===n.id));if(s.length>0){const n=s[Math.floor(Math.random()*s.length)];this.bombDroppers.push({alien:n,lastBombTime:Date.now()+Math.random()*2e3,bombCooldown:this.getRandomBombCooldown()})}}}tryDropBombs(){const t=Date.now();if(!(this.bombPool.getActiveBombCount()>=this.maxSimultaneousBombs)){for(const i of this.bombDroppers)if(i.alien.active&&t-i.lastBombTime>=i.bombCooldown&&this.dropBomb(i.alien)&&(i.lastBombTime=t,i.bombCooldown=this.getRandomBombCooldown(),this.audioSystem&&this.audioSystem.playSound("bomb-drop"),this.bombPool.getActiveBombCount()>=this.maxSimultaneousBombs))break}}dropBomb(t){const e=t.x+t.width/2-2,i=t.y+t.height;return this.bombPool.createBomb(e,i)}getRandomBombCooldown(){return 2e3+Math.random()*3e3}getActiveBombs(){return this.bombPool.getActiveBombs()}reset(){this.bombPool.reset(),this.bombDroppers=[],this.lastBombCheck=0}clearBombs(){this.bombPool.reset()}setDifficulty(t){this.maxSimultaneousBombs=Math.min(4,3+Math.floor(t/5)),this.bombCheckInterval=Math.max(1e3,2e3-t*100);for(const e of this.bombDroppers)e.bombCooldown=this.getRandomBombCooldown()}}class _{constructor(t,e){this.respawnDelay=2e3,this.lastDeathTime=0,this.isRespawning=!1,this.player=t,this.audioSystem=e}setAudioSystem(t){this.audioSystem=t}handlePlayerDeath(){this.isRespawning||(this.lastDeathTime=Date.now(),this.isRespawning=!0,this.audioSystem&&this.audioSystem.playSound("player-death"),this.player.loseLife(),this.player.getLives()>0&&setTimeout(()=>{this.respawnPlayer()},this.respawnDelay))}respawnPlayer(){this.player.getLives()>0?(this.player.respawn(),this.isRespawning=!1,this.audioSystem&&this.audioSystem.playSound("player-respawn")):this.isRespawning=!1}isPlayerRespawning(){return this.isRespawning}getRemainingLives(){return this.player.getLives()}canRespawn(){return this.player.getLives()>0&&!this.player.active}reset(){this.player.reset(o.PLAYER_START_X,o.PLAYER_Y),this.lastDeathTime=0,this.isRespawning=!1}setLives(t){this.player.setLives(t),t<=0&&(this.isRespawning=!1)}forceRespawn(){this.canRespawn()&&this.respawnPlayer()}setRespawnDelay(t){this.respawnDelay=t}getRespawnDelay(){return this.respawnDelay}getTimeSinceDeath(){return Date.now()-this.lastDeathTime}getRespawnProgress(){return this.isRespawning?Math.min(1,this.getTimeSinceDeath()/this.respawnDelay):1}}class u{constructor(t,e,i=20){this.particles=[],this.isActive=!0,this.x=t,this.y=e,this.createExplosionParticles(i)}createExplosionParticles(t){const e=[o.COLORS.EXPLOSION,"#ffaa00","#ff6600","#ff0000","#ffff00"];for(let i=0;i<t;i++){const s=Math.PI*2*i/t+Math.random()*.5,n=2+Math.random()*4,h=2+Math.random()*4,r=500+Math.random()*1e3;this.particles.push({x:this.x,y:this.y,vx:Math.cos(s)*n,vy:Math.sin(s)*n,size:h,lifetime:r,maxLifetime:r,color:e[Math.floor(Math.random()*e.length)],active:!0})}}update(t){let e=!0;for(const i of this.particles)i.active&&(e=!1,i.x+=i.vx,i.y+=i.vy,i.vy+=.1,i.vx*=.98,i.vy*=.98,i.lifetime-=t,i.lifetime<=0&&(i.active=!1));e&&(this.isActive=!1)}render(t){for(const e of this.particles){if(!e.active)continue;const i=e.lifetime/e.maxLifetime,s=e.size*i;t.save(),t.globalAlpha=i,t.fillStyle=e.color,t.shadowBlur=10,t.shadowColor=e.color,t.beginPath(),t.arc(e.x,e.y,s,0,Math.PI*2),t.fill(),t.restore()}}isExpired(){return!this.isActive}getParticles(){return this.particles}}class B{constructor(){this.explosions=[]}createExplosion(t,e,i="medium"){const s=i==="small"?10:i==="medium"?20:40;this.explosions.push(new u(t,e,s))}createPlayerDeathExplosion(t,e){this.explosions.push(new u(t,e,30)),setTimeout(()=>{this.explosions.push(new u(t+10,e+5,15))},100),setTimeout(()=>{this.explosions.push(new u(t-10,e+5,15))},200)}createAlienDeathExplosion(t,e){this.createExplosion(t,e,"small")}createBuildingHitExplosion(t,e){this.createExplosion(t,e,"small")}update(t){for(let e=this.explosions.length-1;e>=0;e--){const i=this.explosions[e];i.update(t),i.isExpired()&&this.explosions.splice(e,1)}}render(t){for(const e of this.explosions)e.render(t)}clear(){this.explosions=[]}getActiveExplosionCount(){return this.explosions.length}getTotalParticleCount(){return this.explosions.reduce((t,e)=>t+e.getParticles().filter(i=>i.active).length,0)}}class M{constructor(){this.spatialGrid=new Map,this.cellSize=50}update(t){this.clearGrid(),this.populateGrid(t)}clearGrid(){this.spatialGrid.clear()}populateGrid(t){for(const e of t){if(!e.active)continue;const i=this.getCellsForEntity(e);for(const s of i)this.spatialGrid.has(s)||this.spatialGrid.set(s,[]),this.spatialGrid.get(s).push(e)}}getCellsForEntity(t){const e=[],i=Math.floor(t.x/this.cellSize),s=Math.floor((t.x+t.width)/this.cellSize),n=Math.floor(t.y/this.cellSize),h=Math.floor((t.y+t.height)/this.cellSize);for(let r=i;r<=s;r++)for(let l=n;l<=h;l++)e.push(`${r},${l}`);return e}checkAABBCollision(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}checkEntityCollisions(t,e){const i=[],s=this.getCellsForEntity(t),n=new Set;for(const h of s){const r=this.spatialGrid.get(h)||[];for(const l of r)l===t||l.type===t.type||n.has(l)||this.checkAABBCollision(t,l)&&(i.push(l),n.add(l))}return i}checkBulletAlienCollisions(t,e){const i=[];for(const s of t){if(!s.active)continue;this.update(e);const n=this.checkEntityCollisions(s,e);for(const h of n)i.push({collided:!0,entity1:s,entity2:h})}return i}checkBombCollisions(t,e){const i=[];for(const s of t){if(!s.active)continue;const n=this.checkEntityCollisions(s,e);for(const h of n)i.push({collided:!0,entity1:s,entity2:h})}return i}checkBombPlayerCollisions(t,e){const i=[];if(!e.active)return i;for(const s of t)s.active&&this.checkAABBCollision(s,e)&&i.push({collided:!0,entity1:s,entity2:e});return i}getCellSize(){return this.cellSize}}class D{constructor(){this.score=0,this.highScore=0,this.scoreHistory=[],this.comboMultiplier=1,this.lastHitTime=0,this.loadHighScore()}addScore(t,e){const i=Date.now();i-this.lastHitTime<1e3?this.comboMultiplier=Math.min(this.comboMultiplier+.5,3):this.comboMultiplier=1;const s=Math.floor(t*this.comboMultiplier);this.score+=s,this.lastHitTime=i;const n={points:s,reason:`${e} (${this.comboMultiplier}x)`,timestamp:i};this.scoreHistory.push(n),this.score>this.highScore&&(this.highScore=this.score,this.saveHighScore())}addAlienScore(){this.addScore(o.ALIEN_POINTS,"alien")}addUFOScore(t=!1){const e=t?o.BONUS_UFO_POINTS:o.UFO_POINTS,i=t?"bonus-ufo":"ufo";this.addScore(e,i)}addLevelBonus(){this.addScore(o.LEVEL_BONUS,"level-complete")}getScore(){return this.score}getHighScore(){return this.highScore}getComboMultiplier(){return this.comboMultiplier}getScoreHistory(){return[...this.scoreHistory]}reset(){this.score=0,this.comboMultiplier=1,this.lastHitTime=0,this.scoreHistory=[]}getRecentScoreEvents(t=5){return this.scoreHistory.slice(-t)}loadHighScore(){try{const t=localStorage.getItem("spaceInvaders_highScore");t&&(this.highScore=parseInt(t,10))}catch(t){console.warn("Failed to load high score:",t),this.highScore=0}}saveHighScore(){try{localStorage.setItem("spaceInvaders_highScore",this.highScore.toString())}catch(t){console.warn("Failed to save high score:",t)}}getFormattedScore(){return this.score.toString().padStart(6,"0")}getFormattedHighScore(){return this.highScore.toString().padStart(6,"0")}setScore(t){this.score=t,this.score>this.highScore&&(this.highScore=this.score,this.saveHighScore())}getStats(){return{currentScore:this.score,highScore:this.highScore,comboMultiplier:this.comboMultiplier,recentHits:this.scoreHistory.length}}}class R{constructor(t){this.currentState="menu",this.previousState="menu",this.currentLevel=1,this.maxLevel=20,this.aliensDestroyed=0,this.aliensPerLevel=48,this.stateTimer=0,this.levelCompleteDelay=2e3,this.gameOverDelay=3e3,this.game=t}getCurrentState(){return this.currentState}getPreviousState(){return this.previousState}setCurrentState(t){this.canTransitionTo(t)&&(this.previousState=this.currentState,this.currentState=t,this.onStateEnter(t))}update(t){switch(this.stateTimer>0&&(this.stateTimer-=t,this.stateTimer<=0&&this.handleTimedTransition()),this.currentState){case"playing":this.updatePlayingState(t);break;case"level-complete":this.updateLevelCompleteState(t);break;case"game-over":this.updateGameOverState(t);break;case"victory":this.updateVictoryState(t);break}}canTransitionTo(t){return{menu:["playing"],playing:["paused","game-over","level-complete","victory"],paused:["playing","menu"],"level-complete":["playing","victory"],"game-over":["menu"],victory:["menu"]}[this.currentState]?.includes(t)||!1}onStateEnter(t){switch(t){case"menu":this.onEnterMenu();break;case"playing":this.onEnterPlaying();break;case"paused":this.onEnterPaused();break;case"level-complete":this.onEnterLevelComplete();break;case"game-over":this.onEnterGameOver();break;case"victory":this.onEnterVictory();break}}onEnterMenu(){console.log("Entered menu state"),this.currentLevel=1,this.aliensDestroyed=0,this.game.setLevel(1),this.game.setLives(3),this.game.setScore(0)}onEnterPlaying(){console.log("Entered playing state"),this.game.resume()}onEnterPaused(){console.log("Entered paused state"),this.game.pause()}onEnterLevelComplete(){console.log(`Level ${this.currentLevel} complete! Bonus UFO incoming!`),this.stateTimer=0;const t=1e3*this.currentLevel;this.game.setScore(this.game.getScore()+t),this.game.clearBombs()}onEnterGameOver(){console.log("Game over!"),this.stateTimer=this.gameOverDelay,this.game.getAudioSystem().playSound("game_over")}onEnterVictory(){console.log("Victory! All 20 levels completed!"),this.stateTimer=this.gameOverDelay,this.game.getAudioSystem().playSound("victory")}updatePlayingState(t){const e=this.game.getAlienGrid(),i=this.game.getUFOSystem();e.getActiveAlienCount()===0&&(console.log("All aliens destroyed!"),i.isActive()?console.log("Bonus UFO already active, waiting..."):(console.log("Spawning bonus UFO and transitioning to level-complete"),this.game.getUFOSystem().spawnBonusUFO(),this.setCurrentState("level-complete"))),this.game.getLives()<=0&&this.setCurrentState("game-over"),this.currentLevel>this.maxLevel&&this.setCurrentState("victory")}updateLevelCompleteState(t){const e=this.game.getUFOSystem();console.log("Level-complete check - UFO active:",e.isActive(),"State timer:",this.stateTimer),!e.isActive()&&this.stateTimer===0&&(console.log("Starting level transition timer"),this.stateTimer=this.levelCompleteDelay,this.game.getAudioSystem().playSound("level_complete"))}updateGameOverState(t){}updateVictoryState(t){}handleTimedTransition(){switch(this.currentState){case"level-complete":this.startNextLevel();break;case"game-over":case"victory":this.setCurrentState("menu");break}}startNextLevel(){this.currentLevel++,this.aliensDestroyed=0,this.currentLevel<=this.maxLevel?(this.game.setLevel(this.currentLevel),this.game.startNewLevel(),this.setCurrentState("playing")):this.setCurrentState("victory")}startGame(){this.currentState==="menu"&&this.setCurrentState("playing")}pauseGame(){this.currentState==="playing"&&this.setCurrentState("paused")}resumeGame(){this.currentState==="paused"&&this.setCurrentState("playing")}returnToMenu(){["paused","game-over","victory"].includes(this.currentState)&&this.setCurrentState("menu")}getCurrentLevel(){return this.currentLevel}getMaxLevel(){return this.maxLevel}getAliensDestroyed(){return this.aliensDestroyed}getAliensPerLevel(){return this.aliensPerLevel}incrementAliensDestroyed(){this.aliensDestroyed++}getLevelProgress(){return this.aliensDestroyed/this.aliensPerLevel}getAlienSpeedMultiplier(){return 1+(this.currentLevel-1)*.1}getAlienFireRateMultiplier(){return 1+(this.currentLevel-1)*.15}getUfoSpawnChanceMultiplier(){return 1+(this.currentLevel-1)*.2}isPlaying(){return this.currentState==="playing"}isPaused(){return this.currentState==="paused"}isGameOver(){return this.currentState==="game-over"}isVictory(){return this.currentState==="victory"}isInMenu(){return this.currentState==="menu"}isInLevelComplete(){return this.currentState==="level-complete"}}class f extends c{constructor(t,e){super(t,e,4,12,"bullet"),this.setColor(o.COLORS.BULLET)}update(t){this.y+=o.BULLET_SPEED,this.y<-20&&this.destroy()}render(t){t.fillStyle=this.color,t.fillRect(this.x,this.y,this.width,this.height)}destroy(){super.destroy()}}class N extends S{constructor(){super(()=>new f(0,0),5,o.MAX_BULLETS)}createBullet(t,e){const i=this.acquire();return i&&(i.setPosition(t,e),i.setColor(o.COLORS.BULLET),i.active=!0),i}update(t){for(let e=this.active.length-1;e>=0;e--){const i=this.active[e];i.update(t),(!i.active||i.y<-20)&&this.release(i)}}createObject(){return new f(0,0)}resetObject(t){t.active=!1,t.setPosition(0,0)}reset(){for(let t=this.active.length-1;t>=0;t--)this.release(this.active[t])}}class U extends c{constructor(t,e){super(t,e,o.PLAYER_WIDTH,o.PLAYER_HEIGHT,"player"),this.speed=o.PLAYER_SPEED,this.canShoot=!0,this.shootCooldown=o.SHOOT_COOLDOWN,this.lastShotTime=0,this.lives=3,this.setColor(o.COLORS.PLAYER)}setInputSystem(t){this.inputSystem=t}setBulletPool(t){this.bulletPool=t}setAudioSystem(t){this.audioSystem=t}update(t){this.inputSystem&&(this.inputSystem.isKeyPressed(d.LEFT)&&this.moveLeft(),this.inputSystem.isKeyPressed(d.RIGHT)&&this.moveRight(),this.inputSystem.isKeyPressed(d.SHOOT)&&this.shoot())}render(t){t.fillStyle=this.color,t.beginPath(),t.moveTo(this.x+this.width/2,this.y),t.lineTo(this.x,this.y+this.height),t.lineTo(this.x+this.width,this.y+this.height),t.closePath(),t.fill(),t.fillRect(this.x+this.width/2-4,this.y+this.height-4,8,4)}moveLeft(){this.x-=this.speed,this.x=Math.max(0,this.x)}moveRight(){this.x+=this.speed,this.x=Math.min(o.CANVAS_WIDTH-this.width,this.x)}shoot(){const t=Date.now();t-this.lastShotTime>=this.shootCooldown&&this.canShoot&&this.bulletPool&&this.bulletPool.createBullet(this.x+this.width/2-2,this.y)&&(this.lastShotTime=t,this.canShoot=!1,this.audioSystem&&this.audioSystem.playSound("shoot"),setTimeout(()=>{this.canShoot=!0},this.shootCooldown))}getLives(){return this.lives}loseLife(){this.lives=Math.max(0,this.lives-1),this.active=!1}reset(t,e){this.x=t,this.y=e,this.lives=3,this.active=!0,this.canShoot=!0,this.lastShotTime=0}respawn(){this.lives>0&&(this.active=!0,this.canShoot=!0,this.lastShotTime=0,this.x=o.PLAYER_START_X,this.y=o.PLAYER_Y)}isAlive(){return this.lives>0}setLives(t){this.lives=Math.max(0,t),this.lives===0&&(this.active=!1)}destroy(){this.active=!1}}class G{constructor(t){this.score=0,this.level=1,this.isRunning=!1,this.state="menu",this.player=null,this.canvas=t.canvas,this.config=t,this.setupCanvas()}start(){this.createGame(),this.isRunning=!0,console.log("Game started in menu state. Press Enter to begin playing.")}pause(){this.gameStateManager.pauseGame()}resume(){this.gameStateManager.resumeGame()}stop(){this.gameStateManager.returnToMenu(),this.inputSystem.destroy()}handleResize(){this.setupCanvas(),this.renderSystem&&this.renderSystem.resize(this.canvas.width,this.canvas.height)}setupCanvas(){this.canvas.width=this.config.width||o.CANVAS_WIDTH,this.canvas.height=this.config.height||o.CANVAS_HEIGHT}createGame(){this.uiSystem=new v(this.canvas),this.renderSystem=new w(this.canvas),this.inputSystem=new b,this.audioSystem=new T,this.alienGrid=new L(this.audioSystem),this.buildingManager=new x,this.ufoSystem=new P,this.collisionSystem=new M,this.scoringSystem=new D,this.gameStateManager=new R(this),this.bulletPool=new N;const t=new U(o.PLAYER_START_X,o.PLAYER_Y);t.setInputSystem(this.inputSystem),t.setBulletPool(this.bulletPool),t.setAudioSystem(this.audioSystem),this.setPlayer(t),this.bombSystem=new I(this.audioSystem),this.playerLifeManager=new _(t,this.audioSystem),this.explosionSystem=new B,this.audioSystem.init().then(()=>{console.log("Audio system initialized")}),this.uiSystem.setScore(this.scoringSystem.getScore()),this.uiSystem.setLives(this.playerLifeManager.getRemainingLives()),this.uiSystem.setLevel(this.level),this.startGameLoop()}startGameLoop(){let t=0;const e=i=>{if(!this.isRunning)return;const s=t?i-t:16.67;t=i;const n=Math.min(s,100);this.update(n),this.render(),requestAnimationFrame(e)};requestAnimationFrame(e)}update(t){if(this.gameStateManager.update(t),this.state=this.gameStateManager.getCurrentState(),this.handleMenuInput(),this.uiSystem.update(t),this.gameStateManager.isPlaying()||this.gameStateManager.isInLevelComplete()){const i=this.gameStateManager.isPlaying();this.ufoSystem.update(t,i),this.bulletPool.update(t),this.explosionSystem.update(t),this.checkCollisions()}this.gameStateManager.isPlaying()&&(this.alienGrid.update(t),this.buildingManager.update(t),this.bombSystem.update(this.alienGrid.getAliens()));const e=this.getPlayer();e&&e.update(t)}handleMenuInput(){const t=this.inputSystem;t.isKeyPressed("Enter")&&(this.gameStateManager.isInMenu()?this.gameStateManager.startGame():(this.gameStateManager.isGameOver()||this.gameStateManager.isVictory())&&this.gameStateManager.returnToMenu()),t.isKeyPressed("Escape")&&(this.gameStateManager.isPlaying()?this.gameStateManager.pauseGame():this.gameStateManager.isPaused()&&this.gameStateManager.resumeGame())}setPlayer(t){this.player=t}getPlayer(){return this.player}render(){this.renderSystem.beginFrame(),(this.gameStateManager.isPlaying()||this.gameStateManager.isInLevelComplete())&&this.renderEntities(),this.uiSystem.render(),this.gameStateManager.isPlaying()?this.gameStateManager.isInLevelComplete()&&this.uiSystem.renderGameState("level-complete"):this.uiSystem.renderGameState(this.gameStateManager.getCurrentState()),this.renderSystem.render(),this.renderSystem.endFrame()}renderEntities(){const t=this.renderSystem.getContext(),e=this.getPlayer();e&&e.active&&e.render(t);const i=this.alienGrid.getAliens();for(const h of i)h.active&&h.render(t);this.buildingManager.render(t),this.ufoSystem.render(t);const s=this.bulletPool.getActive();for(const h of s)h.active&&h.render(t);const n=this.bombSystem.getActiveBombs();for(const h of n)h.active&&h.render(t);this.explosionSystem.render(t)}checkCollisions(){const t=this.bulletPool.getActive(),e=this.alienGrid.getAliens(),i=this.ufoSystem.getUFO(),s=this.bombSystem.getActiveBombs(),n=this.collisionSystem.checkBulletAlienCollisions(Array.from(t),e);for(const r of n)r.collided&&r.entity1&&r.entity2&&(r.entity1.destroy(),r.entity2.destroy(),this.scoringSystem.addAlienScore(),this.uiSystem.setScore(this.scoringSystem.getScore()),this.audioSystem.playSound("alien-hit"));for(const r of t){if(!r.active)continue;const l=this.buildingManager.checkCollisionWithProjectile(r.x,r.y,r.width,r.height);l&&(l.takeDamage(25),r.active=!1,this.audioSystem.playSound("building-hit"))}if(i&&i.active){for(const r of t)if(r.active&&this.checkAABBCollision(r,i)){r.active=!1;const l=this.ufoSystem.destroyUFO();this.scoringSystem.addScore(l,"ufo"),this.uiSystem.setScore(this.scoringSystem.getScore()),this.audioSystem.playSound("ufo-hit");break}}const h=this.getPlayer();if(h&&h.active){const r=this.collisionSystem.checkBombPlayerCollisions(s,h);for(const l of r)l.collided&&l.entity1&&l.entity2&&(l.entity1.destroy(),this.playerLifeManager.isPlayerRespawning()||(this.explosionSystem.createPlayerDeathExplosion(h.x+h.width/2,h.y+h.height/2),this.playerLifeManager.handlePlayerDeath(),this.uiSystem.setLives(this.playerLifeManager.getRemainingLives()),this.audioSystem.playSound("player-death")))}for(const r of s){if(!r.active)continue;const l=this.buildingManager.checkCollisionWithProjectile(r.x,r.y,r.width,r.height);l&&(l.takeDamage(20),r.active=!1,this.explosionSystem.createBuildingHitExplosion(r.x,r.y),this.audioSystem.playSound("building-hit"))}}getScore(){return this.score}getLives(){return this.playerLifeManager.getRemainingLives()}getLevel(){return this.level}setScore(t){this.scoringSystem.setScore(t),this.uiSystem.setScore(this.scoringSystem.getScore())}setLives(t){this.playerLifeManager.setLives(t),this.uiSystem.setLives(this.playerLifeManager.getRemainingLives())}setLevel(t){this.level=t,this.uiSystem.setLevel(t)}getState(){return this.state}getAudioSystem(){return this.audioSystem}getAlienGrid(){return this.alienGrid}getUFOSystem(){return this.ufoSystem}startNewLevel(){this.alienGrid.reset(),this.buildingManager.reset(),this.ufoSystem.reset(),this.bulletPool.reset(),this.bombSystem.reset(),this.explosionSystem.clear()}clearBombs(){this.bombSystem.reset()}checkAABBCollision(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}}document.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("game-canvas");if(!a){console.error("Game canvas not found");return}const t=new G({canvas:a,width:800,height:600,audioEnabled:!0});t.start(),window.addEventListener("resize",()=>{t.handleResize()}),document.addEventListener("click",()=>{},{once:!0})});
